<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Social Media Crime Perception Study</title>
  <!-- React & Babel (for JSX in the browser) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --text: #e6edf3;
      --secondary: #8b949e;
      --accent: #1d9bf0;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    #root{max-width:680px;margin:0 auto;padding:1rem;}
    .tweet{background:var(--card);border-radius:1rem;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 4px rgba(0,0,0,.4);display:flex;gap:.75rem;position:relative;}
    .avatar{width:48px;height:48px;border-radius:50%;flex-shrink:0;}
    .content{flex:1;min-width:0;}
    .handle{font-weight:600;}
    .timestamp{color:var(--secondary);font-size:.85rem;margin-left:.25rem;}
    .body{margin:.5rem 0;white-space:pre-wrap;cursor:pointer;}
    .media-thumb{margin-top:.5rem;border-radius:.75rem;max-width:100%;cursor:pointer;}
    .actions{display:flex;gap:1.5rem;font-size:.9rem;}
    .actions button{background:none;border:none;color:var(--secondary);cursor:pointer;display:flex;align-items:center;gap:.25rem;}
    .actions button.liked,.actions button.retweeted{color:var(--accent);}
    .reply-box textarea{width:100%;background:transparent;border:1px solid var(--secondary);color:var(--text);border-radius:.5rem;padding:.5rem;}
    .reply-box .controls{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.25rem;}
    .focus-header{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;cursor:pointer;color:var(--accent);}
    .sidebar{position:fixed;right:1rem;top:1rem;width:200px;background:var(--card);padding:1rem;border-radius:1rem;box-shadow:0 2px 4px rgba(0,0,0,.4);}
    .hashtag{color:var(--accent);}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:999;}
    .overlay img,.overlay video{max-width:90%;max-height:90%;border-radius:1rem;}
    .poll{background:var(--card);padding:1rem;border-radius:1rem;margin-bottom:1rem;}
    .poll button{background:var(--accent);border:none;color:#fff;padding:.5rem 1rem;border-radius:.5rem;margin-right:.5rem;cursor:pointer;}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useLayoutEffect, useRef } = React;

    /******************** UTILITIES *************************/
    const avatars = [
      'https://i.pravatar.cc/48?img=3',
      'https://i.pravatar.cc/48?img=5',
      'https://i.pravatar.cc/48?img=7',
      'https://i.pravatar.cc/48?img=12',
      'https://i.pravatar.cc/48?img=15',
      'https://i.pravatar.cc/48?img=20'
    ];

    const randomAvatar = () => avatars[Math.floor(Math.random() * avatars.length)];
    const randTimestamp = () => `${Math.floor(Math.random() * 59) + 1}m`;
    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
    const getURLParams = () => Object.fromEntries(new URLSearchParams(window.location.search));

    /******************** MOCK POST FACTORY *************************/
    function generatePosts(valence = 'neutral', engagement = 'low') {
      const base = [
        {
          id: 'main',
          handle: 'CrimeWatch',
          name: 'Crime Watch',
          body: `BREAKING: Shocking incident downtownâ€¦`,
          media: { type: 'image', url: 'https://picsum.photos/seed/incident/600/400' },
          pinned: true
        },
        { id: 'a1', handle: 'Justice4All', name: 'Justice For All', body: `Violence continues because we stay silent.`, media: null },
        { id: 'a2', handle: 'StreetLens', name: 'Street Lens', body: `Hereâ€™s what witnesses told usâ€¦`, media: { type: 'video', url: 'https://samplelib.com/lib/preview/mp4/sample-5s.mp4' } },
        { id: 'a3', handle: 'LocalVoice', name: 'Local Voice', body: `Iâ€™m scared to walk these streets now.`, media: null }
      ];

      base.forEach(p => {
        if (valence === 'sympathetic') p.body += ' ðŸ˜¢';
        else if (valence === 'condemning') p.body += ' ðŸ˜¡';
      });

      const high = engagement === 'high';
      base.forEach(p => {
        p.likes = high ? Math.floor(Math.random() * 900 + 100) : Math.floor(Math.random() * 30);
        p.retweets = high ? Math.floor(Math.random() * 400 + 50) : Math.floor(Math.random() * 10);
        p.comments = [];
        p.avatar = randomAvatar();
        p.timestamp = randTimestamp();
        p.likesToggle = false;
        p.retweetsToggle = false;
      });
      return [base[0], ...shuffle(base.slice(1))];
    }

    /******************** TESTS *************************/
    function runTests() {
      // Ensure every generated post has required properties
      const sample = generatePosts();
      console.assert(sample.length >= 4, 'Should generate at least 4 posts');
      sample.forEach(p => {
        console.assert(p.id, 'Post missing id');
        console.assert(p.avatar, 'Post missing avatar');
        console.assert(typeof p.likes === 'number', 'Post likes not numeric');
      });
      console.log('%cAll internal tests passed!', 'color: #1d9bf0');
    }
    runTests();

    /******************** MAIN APP *************************/
    function App() {
      const params = getURLParams();
      const [posts, setPosts] = useState(() => generatePosts(params.valence, params.engagement));
      const [view, setView] = useState({ mode: 'feed', post: null });
      const [overlayMedia, setOverlayMedia] = useState(null);
      const [participantData, setParticipantData] = useState({ interactions: [], dwell: {}, poll: null, start: Date.now(), views: 0 });
      const [pollShown, setPollShown] = useState(false);
      const trending = ['#Justice', '#Safety', '#Community', '#CrimeNews', '#StayAlert'];
      const [trendIndex, setTrendIndex] = useState(0);

      /************ TRENDING ROTATION *************/
      useEffect(() => {
        const id = setInterval(() => setTrendIndex(i => (i + 1) % trending.length), 3000);
        return () => clearInterval(id);
      }, []);

      /************ DWELL TIME TRACKING *************/
      const observer = useRef(null);
      useLayoutEffect(() => {
        observer.current = new IntersectionObserver(entries => {
          entries.forEach(ent => {
            const id = ent.target.dataset.postid;
            if (!id) return;
            setParticipantData(d => {
              const now = Date.now();
              const prev = d.dwell[id] || { start: null, total: 0 };
              if (ent.isIntersecting) {
                return { ...d, dwell: { ...d.dwell, [id]: { ...prev, start: now } } };
              } else if (prev.start) {
                return { ...d, dwell: { ...d.dwell, [id]: { start: null, total: prev.total + (now - prev.start) } } };
              }
              return d;
            });
          });
        }, { threshold: 0.6 });
        return () => observer.current && observer.current.disconnect();
      }, []);

      /************ DATA LOGGING *************/
      function logInteraction(type, postId, commentId) {
        setParticipantData(d => ({ ...d, interactions: [...d.interactions, { type, postId, commentId, time: Date.now() }] }));
      }

      /************ COMPLETION CHECK *************/
      useEffect(() => {
        const elapsed = (Date.now() - participantData.start) / 1000;
        if (elapsed >= 120 && participantData.interactions.length >= 5 && participantData.views >= 3) {
          exportData();
        }
      }, [participantData]);

      function exportData() {
        const payload = { ...participantData, posts, setup: params, completed: Date.now() };
        const endpoint = params.backend_url || params.backend;
        if (endpoint) {
          fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(() => redirect())
            .catch(() => downloadFallback(payload));
        } else downloadFallback(payload);
      }
      function downloadFallback(obj) {
        const blob = new Blob([JSON.stringify(obj)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'participant_' + (params.participant_id || 'data') + '.json';
        a.click();
        URL.revokeObjectURL(url);
        redirect();
      }
      function redirect() {
        if (params.return_url) window.location.href = params.return_url; else alert('Finished!');
      }

      /************ POST HANDLERS *************/
      function toggleLike(pid, cid = null) {
        setPosts(arr => arr.map(p => p.id === pid ? { ...p, likesToggle: !p.likesToggle, likes: p.likesToggle ? p.likes - 1 : p.likes + 1 } : p));
        logInteraction('like', pid, cid);
      }
      function toggleRetweet(pid, cid = null) {
        setPosts(arr => arr.map(p => p.id === pid ? { ...p, retweetsToggle: !p.retweetsToggle, retweets: p.retweetsToggle ? p.retweets - 1 : p.retweets + 1 } : p));
        logInteraction('retweet', pid, cid);
      }
      function addComment(pid, text, parentId = null) {
        setPosts(arr => arr.map(p => {
          if (p.id !== pid) return p;
          const newComment = { id: Date.now().toString(36), text, likes: 0, retweets: 0, timestamp: 'now', avatar: randomAvatar(), replies: [] };
          if (parentId) {
            return {
              ...p,
              comments: p.comments.map(c => c.id === parentId ? { ...c, replies: [...c.replies, newComment] } : c)
            };
          }
          return { ...p, comments: [...p.comments, newComment] };
        }));
        logInteraction('comment', pid, parentId);
      }

      /************ POLL HANDLER *************/
      function submitPoll(choice) {
        setParticipantData(d => ({ ...d, poll: { choice, time: Date.now() } }));
        setPollShown(true);
      }

      /************ COMPONENTS *************/
      function Tweet({ tweet, isFocus = false }) {
        if (!tweet) return null; // guard against undefined tweet

        const ref = useRef(null);
        // observe visibility
        useEffect(() => {
          if (ref.current && observer.current) {
            observer.current.observe(ref.current);
            return () => { observer.current && observer.current.unobserve(ref.current); };
          }
        }, []);
        // view count increment (once per mount)
        useEffect(() => { if (!isFocus) setParticipantData(d => ({ ...d
